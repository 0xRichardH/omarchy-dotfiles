#!/usr/bin/env bash
set -euo pipefail

# Notes-specific sync script
# Wraps gdrive-sync with predefined paths for notes

GDRIVE_SYNC="$HOME/.bin/gdrive-sync"
GRAPH_LOCAL="$HOME/Notes/gdrive-notes"
GRAPH_REMOTE="gdrive:0xdev/Notes"
BACKUP_REMOTE="gdrive:0xdev/Notes-archive"
BACKUP_LOCAL="$HOME/Notes/gdrive-notes-archive"
LOG_FILE="$HOME/.local/share/rclone-logseq.log"

case "${1:-}" in
  push)
    "$GDRIVE_SYNC" push "$GRAPH_LOCAL" "$GRAPH_REMOTE" "" "$BACKUP_REMOTE" "$LOG_FILE"
    ;;
    
  pull)
    "$GDRIVE_SYNC" pull "$GRAPH_LOCAL" "$GRAPH_REMOTE" "$BACKUP_LOCAL" "" "$LOG_FILE"
    ;;
    
  sync)
    "$GDRIVE_SYNC" sync "$GRAPH_LOCAL" "$GRAPH_REMOTE" "$BACKUP_LOCAL" "$BACKUP_REMOTE" "$LOG_FILE"
    ;;
    
  commit)
    cd "$GRAPH_LOCAL"
    if [[ -d .git ]]; then
      if [[ -n "$(git status --porcelain)" ]]; then
        git add -A
        
        # Generate commit message with OpenCode
        if ! command -v opencode &>/dev/null; then
          echo "Error: opencode is required but not installed" >&2
          exit 1
        fi
        echo "Generating commit message with OpenCode..."
        DIFF_FILE=$(mktemp)
        git diff --cached > "$DIFF_FILE"

        COMMIT_MSG=$(opencode run \
          "Generate a concise commit message (max 72 chars) following conventional commits format based on the attached diff. 
          Output ONLY the raw text of the message. 
          NO markdown blocks, NO quotes, NO preamble, NO explanations." \
          --file "$DIFF_FILE" 2>/dev/null | grep . | tail -n 1 | sed 's/^`*//;s/`*$//;s/^"*//;s/"*$//')

        rm -f "$DIFF_FILE"

        if [[ -z "$COMMIT_MSG" ]]; then
          echo "Error: Failed to generate commit message" >&2
          exit 1
        fi

        git commit -S -m "$COMMIT_MSG"
        echo "Changes committed: $COMMIT_MSG"
      else
        echo "No changes to commit"
      fi
    else
      echo "Error: $GRAPH_LOCAL is not a git repository" >&2
      exit 1
    fi
    ;;
    
  *)
    echo "usage: notes-sync [push|pull|sync|commit]" >&2
    exit 1
    ;;
esac
