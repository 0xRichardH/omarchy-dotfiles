#!/usr/bin/env bash
set -euo pipefail

# General-purpose rclone sync script for Google Drive
# Usage: gdrive-sync <command> <local_path> <remote_path> [backup_local] [backup_remote] [log_file]

show_usage() {
  cat << EOF
Usage: gdrive-sync <command> <local_path> <remote_path> [backup_local] [backup_remote] [log_file]

Commands:
  push  - Sync from local to remote
  pull  - Sync from remote to local
  sync  - Bidirectional sync using bisync

Arguments:
  local_path     - Local directory path
  remote_path    - Remote path (e.g., gdrive:folder/subfolder)
  backup_local   - Local backup directory (optional, for sync command)
  backup_remote  - Remote backup directory (optional, for push/sync commands)
  log_file       - Log file path (optional, defaults to ~/.local/share/rclone-sync.log)

Examples:
  gdrive-sync push ~/Documents gdrive:backup/Documents
  gdrive-sync pull gdrive:Photos ~/Pictures
  gdrive-sync sync ~/Notes gdrive:Notes ~/Notes-backup gdrive:Notes-backup
EOF
}

COMMAND="${1:-}"
LOCAL_PATH="${2:-}"
REMOTE_PATH="${3:-}"
BACKUP_LOCAL="${4:-}"
BACKUP_REMOTE="${5:-}"
LOG_FILE="${6:-$HOME/.local/share/rclone-sync.log}"

# Validate arguments
if [[ -z "$COMMAND" || -z "$LOCAL_PATH" || -z "$REMOTE_PATH" ]]; then
  show_usage
  exit 1
fi

case "$COMMAND" in
  push)
    PUSH_ARGS=(
      --drive-stop-on-upload-limit
      --log-file "$LOG_FILE"
      --log-level INFO
    )
    
    if [[ -n "$BACKUP_REMOTE" ]]; then
      PUSH_ARGS+=(--backup-dir "$BACKUP_REMOTE/$(date +%F)")
    fi
    
    rclone sync "$LOCAL_PATH" "$REMOTE_PATH" "${PUSH_ARGS[@]}"
    ;;
    
  pull)
    PULL_ARGS=(
      --drive-stop-on-upload-limit
      --log-file "$LOG_FILE"
      --log-level INFO
    )
    
    if [[ -n "$BACKUP_LOCAL" ]]; then
      PULL_ARGS+=(--backup-dir "$BACKUP_LOCAL/$(date +%F)")
    fi
    
    rclone sync "$REMOTE_PATH" "$LOCAL_PATH" "${PULL_ARGS[@]}"
    ;;
    
  sync)
    # Generate bisync cache path based on local and remote paths
    # Expand paths first, then normalize
    LOCAL_EXPANDED=$(eval echo "$LOCAL_PATH")
    LOCAL_NORMALIZED=$(echo "$LOCAL_EXPANDED" | sed 's|^/||' | tr '/' '_' | tr ':' '_')
    REMOTE_NORMALIZED=$(echo "$REMOTE_PATH" | tr '/' '_' | tr ':' '_')
    BISYNC_CACHE="$HOME/.cache/rclone/bisync"
    BISYNC_PATH1="$BISYNC_CACHE/${LOCAL_NORMALIZED}..${REMOTE_NORMALIZED}.path1.lst"
    
    # Check if bisync needs initialization
    if [[ ! -f "$BISYNC_PATH1" ]]; then
      echo "First-time bisync setup: initializing with --resync..."
      rclone bisync "$LOCAL_PATH" "$REMOTE_PATH" \
        --resync \
        --drive-stop-on-upload-limit \
        --log-file "$LOG_FILE" \
        --log-level INFO \
        --create-empty-src-dirs
    else
      SYNC_ARGS=(
        --drive-stop-on-upload-limit
        --log-file "$LOG_FILE"
        --log-level INFO
        --resilient
        --recover
        --create-empty-src-dirs
      )
      
      if [[ -n "$BACKUP_LOCAL" ]]; then
        SYNC_ARGS+=(--backup-dir1 "$BACKUP_LOCAL/$(date +%F)")
      fi
      
      if [[ -n "$BACKUP_REMOTE" ]]; then
        SYNC_ARGS+=(--backup-dir2 "$BACKUP_REMOTE/$(date +%F)")
      fi
      
      rclone bisync "$LOCAL_PATH" "$REMOTE_PATH" "${SYNC_ARGS[@]}"
    fi
    ;;
    
  *)
    echo "Error: Unknown command '$COMMAND'" >&2
    show_usage
    exit 1
    ;;
esac
