#!/usr/bin/env python3
"""
Sync credentials from Bitwarden to central credentials directory
"""

import argparse
import logging
import os
import subprocess
import sys
from pathlib import Path
from typing import Dict, Optional


def get_session(session: Optional[str] = None) -> str:
    """
    Function to return a valid Bitwarden session
    (Same logic as bw_add_sshkeys)
    """
    # Check for an existing, user-supplied Bitwarden session
    if not session:
        session = os.environ.get("BW_SESSION", "")
    if session:
        logging.debug("Existing Bitwarden session found")
        return session

    # Check if we're already logged in
    proc_logged = subprocess.run(["bw", "login", "--check", "--quiet"], check=False)

    if proc_logged.returncode:
        logging.debug("Not logged into Bitwarden")
        logging.info("Please login to Bitwarden CLI when prompted")
        operation = "login"
    else:
        logging.debug("Bitwarden vault is locked")
        logging.info("Please unlock your Bitwarden vault when prompted")
        operation = "unlock"

    # Use a more interactive approach
    try:
        # Interactive unlock that inherits stdin to allow password entry
        logging.info(
            f"Running 'bw {operation}' - you'll need to enter your credentials"
        )
        # This allows the Bitwarden CLI to directly access the terminal
        proc = subprocess.run(
            ["bw", "--raw", operation],
            text=True,
            stdout=subprocess.PIPE,
            check=True,
            stdin=sys.stdin,
        )

        session = proc.stdout.strip()
        if not session:
            raise RuntimeError(f"Failed to get session from 'bw {operation}'")

        logging.info(
            'To re-use this BitWarden session run: export BW_SESSION="%s"',
            session,
        )
        return session
    except subprocess.CalledProcessError as e:
        raise RuntimeError(f"Failed to {operation}: {e}")


def get_credential_password(session: str, item_name: str) -> str:
    """
    Get password from a Bitwarden item
    """
    try:
        proc = subprocess.run(
            ["bw", "get", "password", item_name, "--session", session],
            stdout=subprocess.PIPE,
            stderr=subprocess.PIPE,
            text=True,
            check=True,
            timeout=10,
        )
        password = proc.stdout.strip()
        if not password:
            raise RuntimeError(f"Retrieved empty password for '{item_name}'")
        return password
    except subprocess.TimeoutExpired:
        raise RuntimeError(f"Timeout retrieving password for '{item_name}'")
    except subprocess.CalledProcessError as e:
        error_msg = e.stderr.strip() if e.stderr else str(e)
        raise RuntimeError(f"Could not retrieve password for '{item_name}': {error_msg}")


def sync_credential(
    session: str, bw_item_name: str, file_name: str, cred_dir: Path
) -> bool:
    """
    Sync a single credential from Bitwarden to file
    """
    file_path = cred_dir / file_name
    
    logging.info(f"Syncing {file_name} from Bitwarden item: {bw_item_name}")
    
    try:
        password = get_credential_password(session, bw_item_name)
        
        # Write password to file
        file_path.write_text(password)
        file_path.chmod(0o600)
        
        logging.info(f"  ✓ Synced to {file_path}")
        return True
        
    except RuntimeError as error:
        logging.warning(f"  ⚠ {error}")
        return False


def get_service_restart_hint(file_name: str) -> Optional[str]:
    """
    Get restart hint for a service based on credential name
    """
    hints = {
        "opencode_password": "systemctl --user restart opencode.service",
        "crs_auth_token": "systemctl --user restart opencode.service",
        "exa_api_key": "systemctl --user restart opencode.service",
        # Add more service hints here as needed
    }
    return hints.get(file_name)


def main():
    """
    Main program logic
    """
    parser = argparse.ArgumentParser(
        description="Sync credentials from Bitwarden to central credentials directory"
    )
    parser.add_argument(
        "credential",
        nargs="?",
        help="specific credential to sync (if not provided, syncs all)",
    )
    parser.add_argument(
        "-d", "--debug", action="store_true", help="show debug output"
    )
    parser.add_argument(
        "-s", "--session", default="", help="session key for Bitwarden (optional)"
    )
    
    args = parser.parse_args()
    
    # Set up logging
    loglevel = logging.DEBUG if args.debug else logging.INFO
    logging.basicConfig(format="%(levelname)-8s %(message)s", level=loglevel)
    
    # Credential mappings: BW_ITEM_NAME -> filename
    # Add your credentials here
    CREDENTIALS: Dict[str, str] = {
        "OpenCode Server": "opencode_password",
        "CRS_AUTH_TOKEN": "crs_auth_token",
        "EXA_API_KEY": "exa_api_key",
        # Add more credentials as needed:
        # "GitHub Personal Token": "github_token",
        # "CRS Auth Token": "crs_auth_token",
        # "Anthropic API Key": "anthropic_api_key",
    }
    
    # Set up credentials directory
    cred_dir = Path.home() / ".credentials"
    cred_dir.mkdir(mode=0o700, exist_ok=True)
    
    try:
        # Get Bitwarden session
        logging.info("Getting Bitwarden session")
        session = get_session(args.session)
        logging.debug("Session obtained successfully")
        
        print()  # Empty line for readability
        
        # Determine what to sync
        credentials_to_sync = {}
        if args.credential:
            # Sync single credential by filename
            found = False
            for bw_item, file_name in CREDENTIALS.items():
                if file_name == args.credential:
                    credentials_to_sync[bw_item] = file_name
                    found = True
                    break
            
            if not found:
                logging.error(f"Credential '{args.credential}' not found in configuration")
                logging.info("Available credentials:")
                for file_name in CREDENTIALS.values():
                    logging.info(f"  - {file_name}")
                sys.exit(1)
        else:
            # Sync all credentials
            credentials_to_sync = CREDENTIALS
        
        # Sync credentials
        synced_count = 0
        failed_count = 0
        
        for bw_item, file_name in credentials_to_sync.items():
            if sync_credential(session, bw_item, file_name, cred_dir):
                synced_count += 1
            else:
                failed_count += 1
        
        # Lock vault
        print()  # Empty line for readability
        logging.info("Locking Bitwarden vault...")
        subprocess.run(["bw", "lock"], check=False, capture_output=True)
        
        # Summary
        print()
        print("=== Sync Summary ===")
        print(f"✓ Successfully synced: {synced_count}")
        if failed_count > 0:
            print(f"⚠ Failed: {failed_count}")
        print()
        
        # Service restart hints
        if synced_count > 0:
            hints = []
            for bw_item, file_name in credentials_to_sync.items():
                hint = get_service_restart_hint(file_name)
                if hint:
                    hints.append(f"  - {file_name}: {hint}")
            
            if hints:
                print("Hint: You may need to restart services that use these credentials:")
                for hint in hints:
                    print(hint)
        
        sys.exit(0 if failed_count == 0 else 1)
        
    except RuntimeError as error:
        logging.critical(str(error))
        sys.exit(1)
    except KeyboardInterrupt:
        logging.info("Interrupted by user")
        sys.exit(130)
    except Exception as error:
        logging.critical(f"Unexpected error: {error}")
        if args.debug:
            raise
        sys.exit(1)


if __name__ == "__main__":
    main()
